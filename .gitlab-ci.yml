stages:
  - sync
  - test
  - coverage
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.9"

image: python:${PYTHON_VERSION}

cache:
  paths:
    - .cache/pip
    - venv/

before_script:
  - echo "ğŸ› ï¸ Setting up the environment..."
  - python -m venv venv
  - source venv/bin/activate
  - pip install --upgrade pip
  - pip install hatch hatch-vcs


test:
  stage: test
  script:
    - echo "ğŸ§ª Running tests..."
    - hatch test --cover-quiet --randomize --parallel --retries 5 --retry-delay 3
  artifacts:
    paths:
      - .coverage
    expire_in: 1 day

coverage:
  stage: coverage
  needs:
    - job: test
      artifacts: true
  script:
    - echo "ğŸ“Š Generating coverage report..."
    - hatch run coverage:report-xml
    - hatch run coverage:report-uncovered-html
  artifacts:
    paths:
      - htmlcov/
      - coverage.xml
    expire_in: 1 week

build:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  script:
    - echo "ğŸš€ my_arithmetic-antonin-rouxel deployment on develop servers"
    - echo "ğŸ“¦ Building the project..."
    - hatch build
    - echo "ğŸ—‚ï¸ Listing files in the dist/ directory:"
    - ls -l dist/
    - echo "ğŸ“‚ Copying build artifacts..."
    - mkdir -p artifacts
    - cp -r dist/ artifacts/
    - echo "ğŸ§¹ Cleaning up dist/ directory after deployment..."
    - rm -rf dist/
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "ğŸš€ my_arithmetic-antonin-rouxel deployment on stable servers"
    - echo "ğŸ“¦ Building the project..."
    - hatch build
    - echo "ğŸ—‚ï¸ Listing files in the dist/ directory:"
    - ls -l dist/
    - echo "ğŸ“‚ Copying build artifacts..."
    - mkdir -p artifacts
    - cp -r dist/ artifacts/
    - echo "ğŸ§¹ Cleaning up dist/ directory after deployment..."
    - rm -rf dist/
  artifacts:
    paths:
      - artifacts/
    expire_in: 1 week
  only:
    - tags

sync-with-github:
  stage: sync
  before_script:
    - echo "ğŸ”§ Configuring Git user..."
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global pull.ff only 
  script:
    - echo "ğŸ” Checking for GitHub remote..."
    - git remote -v | grep -w github || git remote add github $REMOTE_REPOSITORY_URL
    - echo "ğŸ”„ Setting GitHub repository URL..."
    - git remote set-url github $REMOTE_REPOSITORY_URL
    - echo "ğŸ“‚ Checking out main branch..."
    - git checkout main
    - echo "â¬‡ï¸ Pulling updates from origin main..."
    - git pull origin main --rebase
    - echo "â¬‡ï¸ Pulling updates from GitHub main..."
    - git pull github main --rebase
    - echo "ğŸ“‹ Checking status..."
    - git status
    - echo "ğŸš€ Pushing changes to GitHub..."
    - git push $REMOTE_REPOSITORY_URL HEAD:main --force
    - echo "ğŸ”– Pushing tags to GitHub..."
    - git push $REMOTE_REPOSITORY_URL --tags
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
